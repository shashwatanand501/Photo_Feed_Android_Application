{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _classCallCheck from\"@babel/runtime/helpers/classCallCheck\";import _createClass from\"@babel/runtime/helpers/createClass\";import _assertThisInitialized from\"@babel/runtime/helpers/assertThisInitialized\";import _inherits from\"@babel/runtime/helpers/inherits\";import _possibleConstructorReturn from\"@babel/runtime/helpers/possibleConstructorReturn\";import _getPrototypeOf from\"@babel/runtime/helpers/getPrototypeOf\";function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect===\"undefined\"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy===\"function\")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}import React from\"react\";import TextInput from\"react-native-web/dist/exports/TextInput\";import ActivityIndicator from\"react-native-web/dist/exports/ActivityIndicator\";import TouchableOpacity from\"react-native-web/dist/exports/TouchableOpacity\";import FlatList from\"react-native-web/dist/exports/FlatList\";import StyleSheet from\"react-native-web/dist/exports/StyleSheet\";import Text from\"react-native-web/dist/exports/Text\";import View from\"react-native-web/dist/exports/View\";import Image from\"react-native-web/dist/exports/Image\";import{f,auth,database,storage}from\"../../config/config.js\";import*as ImagePicker from'expo-image-picker';import*as Permissions from'expo-permissions';import UserAuth from\"../components/auth.js\";var upload=function(_React$Component){_inherits(upload,_React$Component);var _super=_createSuper(upload);function upload(props){var _this;_classCallCheck(this,upload);_this=_super.call(this,props);_this._checkPermissions=function _callee(){var _await$Permissions$as,status,_await$Permissions$as2,statusRoll;return _regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regeneratorRuntime.awrap(Permissions.askAsync(Permissions.CAMERA));case 2:_await$Permissions$as=_context.sent;status=_await$Permissions$as.status;_this.setState({camera:status});_context.next=7;return _regeneratorRuntime.awrap(Permissions.askAsync(Permissions.CAMERA_ROLL));case 7:_await$Permissions$as2=_context.sent;statusRoll=_await$Permissions$as2.statusRoll;_this.setState({cameraRoll:statusRoll});case 10:case\"end\":return _context.stop();}}},null,null,null,Promise);};_this.s4=function(){return Math.floor((1+Math.random())*0x10000).toString(16).substring(1);};_this.uniqueId=function(){return _this.s4()+_this.s4()+\"-\"+_this.s4()+\"-\"+_this.s4()+\"-\"+_this.s4()+\"-\"+_this.s4()+\"-\"+_this.s4()+\"-\"+_this.s4();};_this.findNewImage=function _callee2(){var result;return _regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_this._checkPermissions();_context2.next=3;return _regeneratorRuntime.awrap(ImagePicker.launchImageLibraryAsync({mediaTypes:\"Images\",allowsEditing:true,quality:1}));case 3:result=_context2.sent;console.log(result);if(!result.cancelled){console.log(\"upload image\");_this.setState({imageSelected:true,imageId:_this.uniqueId(),uri:result.uri});}else{console.log(\"cancel\");_this.setState({imageSelected:false});}case 6:case\"end\":return _context2.stop();}}},null,null,null,Promise);};_this.uploadPublish=function(){if(_this.state.uploading==false){if(_this.state.caption!=\"\"){_this.uploadImage(_this.state.uri);}else{alert(\"Please enter a caption..\");}}else{console.log(\"Ignore button tap as already uploading\");}};_this.uploadImage=function _callee3(uri){var that,userid,imageId,re,ext,FilePath,oReq;return _regeneratorRuntime.async(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:that=_assertThisInitialized(_this);userid=f.auth().currentUser.uid;imageId=_this.state.imageId;re=/(?:\\.([^.]+))?$/;ext=re.exec(uri)[1];_this.setState({currentFileType:ext,uploading:true});FilePath=imageId+\".\"+that.state.currentFileType;oReq=new XMLHttpRequest();oReq.open(\"GET\",uri,true);oReq.responseType=\"blob\";oReq.onload=function(){var blob=oReq.response;_this.completeUploadBlob(blob,FilePath);};oReq.send();case 12:case\"end\":return _context3.stop();}}},null,null,null,Promise);};_this.completeUploadBlob=function(blob,FilePath){var that=_assertThisInitialized(_this);var userid=f.auth().currentUser.uid;var imageId=_this.state.imageId;var uploadTask=storage.ref(\"user/\"+userid+\"/img\").child(FilePath).put(blob);uploadTask.on(\"state_changed\",function(snapshot){var progress=(snapshot.bytesTransferred/snapshot.totalBytes*100).toFixed(0);console.log(\"Upload is \"+progress+\"% complete\");that.setState({progress:progress});},function(error){console.log(\"error with upload - \"+error);},function(){that.setState({progress:100});uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL){console.log(downloadURL);that.processUpload(downloadURL);});});};_this.processUpload=function(imageUrl){var imageId=_this.state.imageId;var userId=f.auth().currentUser.uid;var caption=_this.state.caption;var dateTime=Date.now();var timestamp=Math.floor(dateTime/1000);var photoObj={author:userId,caption:caption,posted:timestamp,url:imageUrl};database.ref(\"/photos/\"+imageId).set(photoObj);database.ref(\"/users/\"+userId+\"/photos/\"+imageId).set(photoObj);alert(\"Image Uploaded!!\");_this.setState({uploading:false,imageSelected:false,caption:\"\",uri:\"\"});};_this.componentDidMount=function(){var that=_assertThisInitialized(_this);f.auth().onAuthStateChanged(function(user){if(user){that.setState({loggedin:true});}else{that.setState({loggedin:false});}});};_this.state={loggedin:false,imageId:_this.uniqueId(),imageSelected:false,uploading:false,caption:'',progress:0};return _this;}_createClass(upload,[{key:\"render\",value:function render(){var _this2=this;return React.createElement(View,{style:{flex:1}},this.state.loggedin==true?React.createElement(View,{style:{flex:1}},this.state.imageSelected==true?React.createElement(View,{style:{flex:1}},React.createElement(View,{style:{height:70,paddingTop:30,backgroundColor:'white',borderColor:'lightgrey',borderBottomWidth:0.5,justifyContent:'center',alignItems:'center'}},React.createElement(Text,null,\"Upload\")),React.createElement(View,{style:{padding:5}},React.createElement(Text,{style:{marginTop:5}},\"Caption:\"),React.createElement(TextInput,{editable:true,placeholder:\"Enter your caption...\",maxLength:150,multiline:true,numberOfLine:4,onChangeText:function onChangeText(text){return _this2.setState({caption:text});},style:{marginVertical:10,height:100,padding:5,borderColor:'grey',borderWidth:1,borderRadius:3,backgroundColor:'white',color:'black'}}),React.createElement(TouchableOpacity,{onPress:function onPress(){return _this2.uploadPublish();},style:{alignSelf:'center',width:170,marginHorizontal:'auto',backgroundColor:'purple',borderRadius:5,paddingVertical:10,paddingHorizontal:20}},React.createElement(Text,{style:{textAlign:'center',color:'white'}},\"Upload & Publish\")),this.state.uploading==true?React.createElement(View,{style:{marginTop:10}},React.createElement(Text,null,this.state.progress,\"%\"),this.state.progress!=100?React.createElement(ActivityIndicator,{size:\"small\",color:\"blue\"}):React.createElement(Text,null,\"Processing\")):React.createElement(View,null),React.createElement(Image,{source:{uri:this.state.uri},style:{marginTop:1,resizeMode:'cover',width:'100%',height:275}}))):React.createElement(View,{style:{flex:1,justifyContent:'center',alignItems:'center'}},React.createElement(Text,{style:{fontSize:28,paddingBottom:15}},\"Upload\"),React.createElement(TouchableOpacity,{onPress:function onPress(){return _this2.findNewImage();},style:{paddingVertical:10,paddingHorizontal:20,backgroundColor:'blue',borderRadius:5}},React.createElement(Text,{style:{color:'white'}},\"Select Photo\")))):React.createElement(UserAuth,{message:\"Please login to upload a photo\"}));}}]);return upload;}(React.Component);export default upload;","map":{"version":3,"sources":["E:/photofeed/app/screens/upload.js"],"names":["React","f","auth","database","storage","ImagePicker","Permissions","UserAuth","upload","props","_checkPermissions","askAsync","CAMERA","status","setState","camera","CAMERA_ROLL","statusRoll","cameraRoll","s4","Math","floor","random","toString","substring","uniqueId","findNewImage","launchImageLibraryAsync","mediaTypes","allowsEditing","quality","result","console","log","cancelled","imageSelected","imageId","uri","uploadPublish","state","uploading","caption","uploadImage","alert","that","userid","currentUser","uid","re","ext","exec","currentFileType","FilePath","oReq","XMLHttpRequest","open","responseType","onload","blob","response","completeUploadBlob","send","uploadTask","ref","child","put","on","snapshot","progress","bytesTransferred","totalBytes","toFixed","error","getDownloadURL","then","downloadURL","processUpload","imageUrl","userId","dateTime","Date","now","timestamp","photoObj","author","posted","url","set","componentDidMount","onAuthStateChanged","user","loggedin","flex","height","paddingTop","backgroundColor","borderColor","borderBottomWidth","justifyContent","alignItems","padding","marginTop","text","marginVertical","borderWidth","borderRadius","color","alignSelf","width","marginHorizontal","paddingVertical","paddingHorizontal","textAlign","resizeMode","fontSize","paddingBottom","Component"],"mappings":"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","sourcesContent":["import React from \"react\";\r\nimport { TextInput, ActivityIndicator, TouchableOpacity, FlatList, StyleSheet, Text, View, Image } from \"react-native\";\r\nimport { f, auth, database, storage } from \"../../config/config.js\";\r\nimport * as ImagePicker from 'expo-image-picker';\r\nimport * as Permissions from 'expo-permissions';\r\n\r\n\r\nimport UserAuth from \"../components/auth.js\";\r\n\r\nclass upload extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n    this.state = {\r\n      loggedin: false,\r\n      imageId: this.uniqueId(),\r\n      imageSelected: false,\r\n      uploading: false,\r\n      caption: '',\r\n      progress: 0\r\n    };\r\n  }\r\n\r\n  _checkPermissions = async () => {\r\n    const { status } = await Permissions.askAsync(Permissions.CAMERA);\r\n    this.setState({ camera: status });\r\n\r\n    const { statusRoll } = await Permissions.askAsync(Permissions.CAMERA_ROLL);\r\n    this.setState({ cameraRoll: statusRoll });\r\n  };\r\n\r\n  s4 = () => {\r\n    return Math.floor((1 + Math.random()) * 0x10000)\r\n      .toString(16)\r\n      .substring(1);\r\n  };\r\n  uniqueId = () => {\r\n    return (\r\n      this.s4() + this.s4() + \"-\" + this.s4() + \"-\" + this.s4() + \"-\" + this.s4() + \"-\" + this.s4() + \"-\" + this.s4() + \"-\" + this.s4()\r\n    );\r\n  };\r\n\r\n  findNewImage = async () => {\r\n    this._checkPermissions();\r\n\r\n    let result = await ImagePicker.launchImageLibraryAsync({\r\n      mediaTypes: \"Images\",\r\n      allowsEditing: true,\r\n      quality: 1\r\n    });\r\n\r\n    console.log(result);\r\n\r\n    if (!result.cancelled) {\r\n      console.log(\"upload image\");\r\n      this.setState({\r\n        imageSelected: true,\r\n        imageId: this.uniqueId(),\r\n        uri: result.uri\r\n      });\r\n      //this.uploadImage(result.uri);\r\n    } else {\r\n      console.log(\"cancel\");\r\n      this.setState({\r\n        imageSelected: false\r\n      });\r\n    }\r\n  };\r\n\r\n  uploadPublish = () => {\r\n    if (this.state.uploading == false) {\r\n      if (this.state.caption != \"\") {\r\n        //\r\n        this.uploadImage(this.state.uri);\r\n      } else {\r\n        alert(\"Please enter a caption..\");\r\n      }\r\n    } else {\r\n      console.log(\"Ignore button tap as already uploading\");\r\n    }\r\n  };\r\n\r\n  uploadImage = async uri => {\r\n    //\r\n    var that = this;\r\n    var userid = f.auth().currentUser.uid;\r\n    var imageId = this.state.imageId;\r\n\r\n    var re = /(?:\\.([^.]+))?$/;\r\n    var ext = re.exec(uri)[1];\r\n    this.setState({\r\n      currentFileType: ext,\r\n      uploading: true\r\n    });\r\n\r\n    /*const response = await fetch(uri);\r\n    const blob = await response.blob();*/\r\n    var FilePath = imageId + \".\" + that.state.currentFileType;\r\n\r\n    const oReq = new XMLHttpRequest();\r\n    oReq.open(\"GET\", uri, true);\r\n    oReq.responseType = \"blob\";\r\n    oReq.onload = () => {\r\n      const blob = oReq.response;\r\n      //Call function to complete upload with the new blob to handle the uploadTask.\r\n      this.completeUploadBlob(blob, FilePath);\r\n    };\r\n    oReq.send();\r\n\r\n    /*var uploadTask = storage.ref('user/'+userid+'/img').child(FilePath).put(blob);\r\n\r\n    uploadTask.on('state_changed', function(snapshot){\r\n      var progress = ((snapshot.bytesTransferred / snapshot.totalBytes) * 100).toFixed(0);\r\n      console.log('Upload is '+progress+'% complete');\r\n      that.setState({\r\n        progress:progress,\r\n      });\r\n    }, function(error) {\r\n      console.log('error with upload - '+error);\r\n    }, function(){\r\n      //complete\r\n      that.setState({progress:100});\r\n      uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL){\r\n        console.log(downloadURL);\r\n        that.processUpload(downloadURL);\r\n      });\r\n\r\n    });*/\r\n  };\r\n\r\n  completeUploadBlob = (blob, FilePath) => {\r\n    var that = this;\r\n    var userid = f.auth().currentUser.uid;\r\n    var imageId = this.state.imageId;\r\n\r\n    var uploadTask = storage\r\n      .ref(\"user/\" + userid + \"/img\")\r\n      .child(FilePath)\r\n      .put(blob);\r\n\r\n    uploadTask.on(\r\n      \"state_changed\",\r\n      function(snapshot) {\r\n        var progress = (\r\n          (snapshot.bytesTransferred / snapshot.totalBytes) *\r\n          100\r\n        ).toFixed(0);\r\n        console.log(\"Upload is \" + progress + \"% complete\");\r\n        that.setState({\r\n          progress: progress\r\n        });\r\n      },\r\n      function(error) {\r\n        console.log(\"error with upload - \" + error);\r\n      },\r\n      function() {\r\n        //complete\r\n        that.setState({ progress: 100 });\r\n        uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {\r\n          console.log(downloadURL);\r\n          that.processUpload(downloadURL);\r\n        });\r\n      }\r\n    );\r\n  };\r\n\r\n  processUpload = imageUrl => {\r\n    //Process here...\r\n\r\n    //Set needed info\r\n    var imageId = this.state.imageId;\r\n    var userId = f.auth().currentUser.uid;\r\n    var caption = this.state.caption;\r\n    var dateTime = Date.now();\r\n    var timestamp = Math.floor(dateTime / 1000);\r\n    //Build photo object\r\n    //author, caption, posted, url\r\n\r\n    var photoObj = {\r\n      author: userId,\r\n      caption: caption,\r\n      posted: timestamp,\r\n      url: imageUrl\r\n    };\r\n\r\n    //Update database\r\n\r\n    //Add to main feed\r\n    database.ref(\"/photos/\" + imageId).set(photoObj);\r\n\r\n    //Set user photos object\r\n    database.ref(\"/users/\" + userId + \"/photos/\" + imageId).set(photoObj);\r\n\r\n    alert(\"Image Uploaded!!\");\r\n\r\n    this.setState({\r\n      uploading: false,\r\n      imageSelected: false,\r\n      caption: \"\",\r\n      uri: \"\"\r\n    });\r\n  };\r\n\r\n  componentDidMount = () => {\r\n    var that = this;\r\n    f.auth().onAuthStateChanged(function(user) {\r\n      if (user) {\r\n        //Logged in\r\n        that.setState({\r\n          loggedin: true\r\n        });\r\n      } else {\r\n        //Not logged in\r\n        that.setState({\r\n          loggedin: false\r\n        });\r\n      }\r\n    });\r\n  };\r\n\r\n  render() {\r\n    return (\r\n      <View style={{flex:1}}>\r\n        {this.state.loggedin == true ? (\r\n          //are logged in\r\n          <View style={{flex:1}}>\r\n            \r\n            {this.state.imageSelected == true ? (\r\n              <View style={{flex:1}}>\r\n                <View\r\n                  style={{\r\n                    height:70,\r\n                    paddingTop:30,\r\n                    backgroundColor:'white',\r\n                    borderColor:'lightgrey',\r\n                    borderBottomWidth:0.5,\r\n                    justifyContent:'center',\r\n                    alignItems:'center'\r\n                  }}\r\n                >\r\n                  <Text>Upload</Text>\r\n                </View>\r\n                <View style={{padding:5}}>\r\n                  <Text style={{marginTop:5}}>Caption:</Text>\r\n                  <TextInput\r\n                    editable={true}\r\n                    placeholder={\"Enter your caption...\"}\r\n                    maxLength={150}\r\n                    multiline={true}\r\n                    numberOfLine={4}\r\n                    onChangeText={text => this.setState({ caption: text })}\r\n                    style={{\r\n                      marginVertical:10,\r\n                      height:100,\r\n                      padding:5,\r\n                      borderColor:'grey',\r\n                      borderWidth:1,\r\n                      borderRadius:3,\r\n                      backgroundColor:'white',\r\n                      color:'black'\r\n                    }}\r\n                  />\r\n\r\n                  <TouchableOpacity\r\n                    onPress={() => this.uploadPublish()}\r\n                    style={{\r\n                      alignSelf:'center',\r\n                      width:170,\r\n                      marginHorizontal:'auto',\r\n                      backgroundColor:'purple',\r\n                      borderRadius:5,\r\n                      paddingVertical:10,\r\n                      paddingHorizontal:20\r\n                    }}\r\n                  >\r\n                    <Text style={{textAlign:'center',color:'white'}}>\r\n                      Upload & Publish\r\n                    </Text>\r\n                  </TouchableOpacity>\r\n\r\n                  {this.state.uploading == true ? (\r\n                    <View style={{marginTop:10}}>\r\n                      <Text>{this.state.progress}%</Text>\r\n                      {this.state.progress != 100 ? (\r\n                        <ActivityIndicator size=\"small\" color=\"blue\" />\r\n                      ) : (\r\n                        <Text>Processing</Text>\r\n                      )}\r\n                    </View>\r\n                  ) : (\r\n                    <View />\r\n                  )}\r\n\r\n                  <Image\r\n                    source={{uri:this.state.uri}}\r\n                    style={{\r\n                      marginTop:1,\r\n                      resizeMode:'cover',\r\n                      width:'100%',\r\n                      height:275\r\n                    }}\r\n                  />\r\n                </View>\r\n              </View>\r\n            ) : (\r\n              <View\r\n                style={{\r\n                  flex:1,\r\n                  justifyContent:'center',\r\n                  alignItems:'center'\r\n                }}\r\n              >\r\n                <Text style={{fontSize:28,paddingBottom:15}}>Upload</Text>\r\n                <TouchableOpacity\r\n                  onPress={() => this.findNewImage()}\r\n                  style={{\r\n                    paddingVertical:10,\r\n                    paddingHorizontal:20,\r\n                    backgroundColor:'blue',\r\n                    borderRadius:5\r\n                  }}\r\n                >\r\n                  <Text style={{color:'white'}}>Select Photo</Text>\r\n                </TouchableOpacity>\r\n              </View>\r\n            )}\r\n          </View>\r\n        ) : (\r\n          //not logged in\r\n          <UserAuth message={\"Please login to upload a photo\"} />\r\n        )}\r\n      </View>\r\n    );\r\n  }\r\n}\r\n\r\nexport default upload;\r\n"]},"metadata":{},"sourceType":"module"}